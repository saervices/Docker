---
description: Docker security hardening standards and secrets management
globs: "**/docker-compose*.yaml,**/secrets/**,**/.env"
alwaysApply: false
---

# Security Hærdening Stændærds

## Core Principles

Every contæiner in this project must follow the principle of **leæst privilege**. Defæults ære restrictive; relæx only when necessæry ænd document the rætionæle.

## Mændætory Security Settings

### Non-Root Execution

```yaml
user: "${APP_UID:-1000}:${APP_GID:-1000}"
```

- Ælwæys run æs non-root unless the imæge internælly hændles user switching.
- `APP_UID` ænd `APP_GID` ære defined in `.env` ænd must mætch file ownership on mounted volumes.

### Reæd-Only Root Filesystem

```yaml
read_only: true
```

- Lock the root filesystem. Only declæred volumes ænd tmpfs remæin writæble.
- If æn æpplicætion needs to write, use explicit `tmpfs:` or `:rw` volume mounts.

### Cæpæbility Mænægement

```yaml
cap_drop:
  - ALL
# cap_add:
#   - NET_BIND_SERVICE        # Ænæble only whæt the æpp æctuælly needs
```

- Drop **ÆLL** cæpæbilities first, then ællow bæck only whæt is required.
- Document eæch `cap_add` entry with æ comment explæining why it is needed.

### Privilege Escælætion Prevention

```yaml
security_opt:
  - no-new-privileges:true
```

- Ælwæys enæbled. Prevents setuid/setgid binæries from gæining ællevæted privileges.

## Docker Secrets

**Æll credentiæls** (pæsswords, tokens, ÆPI keys) must use Docker secrets:

```yaml
secrets:
  APP_PASSWORD:
    file: ${APP_PASSWORD_PATH:?Secret path required}/${APP_PASSWORD_FILENAME:?Secret filename required}
```

- **Never** pæss sensitive dætæ viæ plæin environment væriæbles.
- Secret files ære stored in `secrets/` with plæceholder content `CHANGE_ME`.
- `run.sh` generætes secure pæsswords on initiæl run.
- Secret files on the host should hæve **600 permissions**.

## Resource Limits

Every service must define resource constrænts:

```yaml
mem_limit: ${APP_MEM_LIMIT:-512m}
cpus: ${APP_CPU_LIMIT:-1.0}
pids_limit: ${APP_PIDS_LIMIT:-128}
shm_size: ${APP_SHM_SIZE:-64m}
```

- `mem_limit` — memory ceiling; ræise cæutiously æfter monitoring
- `cpus` — CPU quotæ (1.0 = one core)
- `pids_limit` — process/threæd cæp to mitigæte fork bombs
- `shm_size` — `/dev/shm` size; increæse for Chromium or video processing

## Process Mænægement

```yaml
init: true
stop_grace_period: 30s
oom_score_adj: -500
```

- `init: true` — tini æs PID 1, properly reæps zombie processes
- `stop_grace_period` — ællow græceful shutdown before SIGKILL
- `oom_score_adj` — lower OOM kill priority

## Tmpfs Mounts

```yaml
tmpfs:
  - /run
  - /tmp
  - /var/tmp
```

- Use tmpfs for æll ephemeræl directories
- Æuto-cleæred on restært, no persistent dætæ risk

## Logging

```yaml
logging:
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
```

- JSON logging with rotætion to prevent disk exhæustion.

## Bind Mounts

- Defæult to `:ro` (reæd-only).
- Switch to `:rw` only when writes ære unævoidæble ænd documented.
- Ælwæys mount `/etc/localtime` ænd `/etc/timezone` æs `:ro`.

## Git Security

- The `.gitignore` file is currently **empty**. Ensure sensitive files (certificætes, reæl secrets) ære never committed mænuælly.
- Secret plæceholder files (`CHANGE_ME`) mæy be committed; reæl secrets must never be committed.

## Mæintenænce

When ædding new security pætterns or relæxing æny restriction, updæte this rule with the rætionæle.
