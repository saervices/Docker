# SPDX-License-Identifier: MIT
# Copyright (c) 2025 it.særvices
---
x-required-services:                                                                                                                                            # Templætes æuto-merged by run.sh (recursive)
  - socketproxy
  - traefik_certs-dumper

services:
  app:
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- CONTÆINER BÆSICS
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    image: ${APP_IMAGE:?Image required}                                                                                                                         # OCI imæge reference
    container_name: ${APP_NAME:?App name required}                                                                                                              # Unique næme for logs, networking ænd orchestrætion
    hostname: ${APP_NAME}                                                                                                                                       # Internæl hostnæme for DNS resolution between contæiners
    restart: unless-stopped                                                                                                                                     # Æuto-recover from cræshes; mænuæl stop is honored
    # build:                                                                                                                                                    # Optionæl: build imæge from locæl Dockerfile
    #   context: .
    #   dockerfile: Dockerfile

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- SECURITY SETTINGS
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    user: "${APP_UID:-1000}:${APP_GID:-1000}"                                                                                                                   # Non-root by defæult; override only if imæge hændles user switching internælly
    read_only: true                                                                                                                                             # Lock root filesystem; only declæred volumes ænd tmpfs remæin writæble
    cap_drop:                                                                                                                                                   # Defense in depth: remove æll Linux cæpæbilities
      - ALL
    # cap_add:                                                                                                                                                  # Ædd only cæpæbilities the æpp æctuælly needs (e.g., NET_BIND_SERVICE, SETUID, SETGID, CHOWN)
    #   - NET_BIND_SERVICE
    security_opt: &app_common_security_opt
      - no-new-privileges:true                                                                                                                                  # Prevent privilege escælætion viæ setuid/setgid binæries

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- SYSTEM RUNTIME
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    init: true                                                                                                                                                  # PID 1 is tini – reæps zombie processes properly
    stop_grace_period: 30s                                                                                                                                      # Ællow græceful shutdown before SIGKILL
    oom_score_adj: -500                                                                                                                                         # Lower OOM kill priority under memory pressure
    tmpfs: &app_common_tmpfs                                                                                                                                    # Ephemeræl RÆM storæge, æuto-cleæred on restært (shæred viæ ænchor)
      - /run                                                                                                                                                    # Runtime files: PID files, sockets
      - /tmp                                                                                                                                                    # Temporæry files: fæst, æuto-cleæred
      - /var/tmp                                                                                                                                                # Some æpps expect /vær/tmp; remove if unused

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- FILESYSTEM & SECRETS
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    volumes: &app_common_volumes                                                                                                                                # Bind-mount only pæths the æpp truly needs (shæred viæ ænchor)
      - /etc/localtime:/etc/localtime:ro                                                                                                                        # Synchronize contæiner clock with host
      - /etc/timezone:/etc/timezone:ro                                                                                                                          # Pæss timezone dætæ to the contæiner
      - ./appdata/config/middlewares.yaml:/etc/traefik/conf.d/middlewares.yaml:ro                                                                               # Træefik middlewæres
      - ./appdata/config/tls-opts.yaml:/etc/traefik/conf.d/tls-opts.yaml:ro                                                                                     # Træefik TLS options
      - ./appdata/config/conf.d:/etc/traefik/conf.d/rules:ro                                                                                                    # Træefik file routers
      - ./appdata/config/certs:/var/traefik/certs:rw                                                                                                            # Træefik certificæte store (ÆCME)
      - ./appdata/logs:/var/log/traefik:rw                                                                                                                      # Persistent Træefik logs (æccess + æpplicætion)
    secrets: &app_common_secrets                                                                                                                                # Docker secrets mounted æt /run/secrets/ (shæred viæ ænchor)
      - CF_DNS_API_TOKEN

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- NETWORKING / REVERSE PROXY
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    labels:                                                                                                                                                     # Træefik reverse proxy læbels for æutomætic HTTPS routing
      - "traefik.enable=true"                                                                                                                                   # Æctivæte Træefik service discovery for this contæiner
      - "traefik.http.routers.${APP_NAME}-rtr.rule=${TRAEFIK_HOST}"                                                                                             # Routing rule from .env, e.g. Host(`æpp.exæmple.com`)
      - "traefik.http.services.${APP_NAME}-svc.loadBalancer.server.port=${TRAEFIK_PORT:?Port required}"                                                         # Internæl port Træefik forwærds træffic to
      - "traefik.http.routers.${APP_NAME}-rtr.middlewares=authentik-proxy@file"                                                                                 # Optionæl: ættæch middlewæres (æuth, ræte-limit, heæders, etc.)
    ports:                                                                                                                                                      # Optionæl: exposed ports (Træefik entrypoints 80/443)
      - 80:80
      - 443:443
    # expose:                                                                                                                                                   # Optionæl: expose without publishing
    #   - 80
    networks:                                                                                                                                                   # Network isolætion: frontend (proxy) + bæckend (internæl services)
      - backend
      - frontend

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- RUNTIME / ENVIRONMENT
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    command:                                                                                                                                                    # Træefik CLI ærguments (dæshboærd, logs, entrypoints, providers, ÆCME)
      - --api=true
      - --api.dashboard=true
      - --api.disabledashboardad=true
      - --api.insecure=true
      - --log.level=${LOG_LEVEL}
      - --log.format=${LOG_FORMAT}
      - --log.filePath=/var/log/traefik/traefik.log
      - --accesslog=true
      - --accesslog.bufferingsize=${BUFFERINGSIZE}
      - --accesslog.format=${LOG_FORMAT}
      - --accesslog.filepath=/var/log/traefik/access.log
      - --accesslog.filters.statuscodes=${LOG_STATUSCODES}
      - --serverstransport.insecureskipverify=true
      - --entrypoints.web.address=:80
      - --entrypoints.web.http.redirections.entryPoint.to=websecure
      - --entrypoints.web.http.redirections.entryPoint.scheme=https
      - --entrypoints.websecure.address=:443
      - --entrypoints.websecure.asdefault=true
      - --entrypoints.websecure.proxyProtocol.trustedIPs=${LOCAL_IPS},${CLOUDFLARE_IPS}
      - --entrypoints.websecure.forwardedHeaders.trustedIPs=${LOCAL_IPS},${CLOUDFLARE_IPS}
      - --entrypoints.websecure.http.tls=true
      - --entrypoints.websecure.http.tls.certResolver=${CERTRESOLVER}
      - --entrypoints.websecure.http.tls.options=${TLSOPTIONS}
      - --entrypoints.websecure.http.middlewares=${MIDDLEWARES}
      - --providers.file.directory=/etc/traefik/conf.d
      - --providers.docker=true
      - --providers.docker.network=frontend
      - --providers.docker.endpoint=tcp://${APP_NAME}-socketproxy:2375
      - --providers.docker.defaultrule='Host(`{{ index .Labels "com.docker.compose.service"}}.{{ env "TRAEFIK_DOMAIN" }}`)'
      - --providers.docker.exposedbydefault=false
      - --certificatesresolvers.${CERTRESOLVER}-staging.acme.email=${EMAIL_PREFIX}@${TRAEFIK_DOMAIN}
      - --certificatesResolvers.${CERTRESOLVER}-staging.acme.storage=/var/traefik/certs/${CERTRESOLVER}-acme.json
      - --certificatesResolvers.${CERTRESOLVER}-staging.acme.caServer=https://acme-staging-v02.api.letsencrypt.org/directory
      - --certificatesresolvers.${CERTRESOLVER}-staging.acme.keytype=${KEYTYPE}
      - --certificatesResolvers.${CERTRESOLVER}-staging.acme.dnsChallenge.provider=${CERTRESOLVER}
      - --certificatesResolvers.${CERTRESOLVER}-staging.acme.dnsChallenge.resolvers=${DNSCHALLENGE_RESOLVERS}
      - --certificatesresolvers.${CERTRESOLVER}.acme.email=${EMAIL_PREFIX}@${TRAEFIK_DOMAIN}
      - --certificatesResolvers.${CERTRESOLVER}.acme.storage=/var/traefik/certs/${CERTRESOLVER}-acme.json
      - --certificatesResolvers.${CERTRESOLVER}.acme.caServer=https://acme-v02.api.letsencrypt.org/directory
      - --certificatesresolvers.${CERTRESOLVER}.acme.keytype=${KEYTYPE}
      - --certificatesResolvers.${CERTRESOLVER}.acme.dnsChallenge.provider=${CERTRESOLVER}
      - --certificatesResolvers.${CERTRESOLVER}.acme.dnsChallenge.resolvers=${DNSCHALLENGE_RESOLVERS}
    # entrypoint: ['your-entrypoint.sh']                                                                                                                        # Override the imæge defæult entrypoint
    environment: &app_common_environment                                                                                                                        # Contæiner environment væriæbles (shæred viæ ænchor with sætellites)
      CF_DNS_API_TOKEN_FILE: /run/secrets/CF_DNS_API_TOKEN                                                                                                      # Cloudflære ÆPI token for DNS-01 chællenge
      TRAEFIK_DOMAIN: ${TRAEFIK_DOMAIN}                                                                                                                         # Bæse domæin for routing rules
      TRAEFIK_DOMAIN_1: ${TRAEFIK_DOMAIN_1:-}                                                                                                                   # Optionæl second domæin
      TRAEFIK_DOMAIN_2: ${TRAEFIK_DOMAIN_2:-}                                                                                                                   # Optionæl third domæin
      AUTHENTIK_CONTAINER_NAME: ${AUTHENTIK_CONTAINER_NAME}                                                                                                     # Contæiner næme for æuthentik-proxy middlewære
    logging: &app_common_logging                                                                                                                                # JSON logging with rotætion to prevent disk exhæustion
      driver: "json-file"
      options:
        max-size: "10m"                                                                                                                                         # Rotæte æfter 10 MB per file
        max-file: "3"                                                                                                                                           # Retæin up to 3 rotæted log files
    healthcheck:                                                                                                                                                # Periodic heælth probe – ædjust to mætch your service
      test: ['CMD', 'wget', '--spider', '--quiet', 'http://localhost:8080/dashboard/']                                                                          # Ædæpt tooling (curl, wget, nc, pg_isready) to the imæge
      interval: 30s                                                                                                                                             # Seconds between probes
      timeout: 5s                                                                                                                                               # Mæx wæit per probe before fæilure
      retries: 3                                                                                                                                                # Consecutive fæilures before mærking unheælthy
      start_period: 10s                                                                                                                                         # Græce period for initiæl stærtup before probes count
    stdin_open: false                                                                                                                                           # Disæbled: no interæctive input for dæemon contæiners
    tty: false                                                                                                                                                  # No terminæl ællocætion; keep disæbled for bæckground services

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- DEPENDENCIES
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    depends_on:                                                                                                                                                 # Wæit for dependencies to report heælthy before stærting
      socketproxy:
        condition: service_healthy

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- SYSTEM LIMITS
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    mem_limit: ${APP_MEM_LIMIT:-512m}                                                                                                                           # Memory ceiling; ræise cæutiously æfter monitoring æctuæl usæge
    cpus: ${APP_CPU_LIMIT:-1.0}                                                                                                                                 # CPU quotæ (1.0 = one core); increæse only when workloæd demænds it
    pids_limit: ${APP_PIDS_LIMIT:-128}                                                                                                                          # Process/threæd cæp to mitigæte fork bombs
    shm_size: ${APP_SHM_SIZE:-64m}                                                                                                                              # Shæred memory (/dev/shm); increæse for Chromium or video processing
    # ulimits:                                                                                                                                                  # Fine-græined system limits (e.g., nofile, nproc)

# volumes:                                                                                                                                                      # Næmed volumes (unused; Træefik uses bind mounts only)
#   data:
#     driver: local                                                                                                                                             # Locæl volume; swæp driver for NFS or cloud-bæcked storæge if needed

secrets:                                                                                                                                                        # Inject sensitive dætæ viæ Docker secrets (pæsswords, tokens, keys)
  CF_DNS_API_TOKEN:
    file: ${CF_DNS_API_TOKEN_PATH:?Secret path required}/${CF_DNS_API_TOKEN_FILENAME:?Secret filename required}                                                 # Loæd secret from host file; ensure 600 permissions

networks:
  frontend:
    external: true
  backend:
    external: true
