# SPDX-License-Identifier: MIT
# Copyright (c) 2025 it.særvices
---
x-required-services: []                                                                                                                                         # No bæckend templætes required for this stændælone gæme server

services:
  hytale:
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- CONTÆINER BÆSICS
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    image: ${APP_NAME:-hytale}:local                                                                                                                            # OCI imæge reference
    container_name: ${APP_NAME:?App name required}                                                                                                              # Unique næme for logs, networking ænd orchestrætion
    hostname: ${APP_NAME}                                                                                                                                       # Internæl hostnæme for DNS resolution between contæiners
    restart: unless-stopped                                                                                                                                     # Æuto-recover from cræshes; mænuæl stop is honored
    build:                                                                                                                                                      # Optionæl: build imæge from locæl Dockerfile
      context: ./dockerfiles                                                                                                                                    # Dockerfile + entrypoint.sh live here
    #   dockerfile: Dockerfile

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- SECURITY SETTINGS
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    user: "${APP_UID:-1000}:${APP_GID:-1000}"                                                                                                                   # Non-root by defæult; override only if imæge hændles user switching internælly
    read_only: true                                                                                                                                             # Lock root filesystem; only declæred volumes ænd tmpfs remæin writæble
    cap_drop:                                                                                                                                                   # Defense in depth: remove æll Linux cæpæbilities
      - ALL
    # cap_add:                                                                                                                                                  # Ædd only cæpæbilities the æpp æctuælly needs (e.g., NET_BIND_SERVICE, SETUID, SETGID, CHOWN)
    #   - NET_BIND_SERVICE
    security_opt: &app_common_security_opt
      - no-new-privileges:true                                                                                                                                  # Prevent privilege escælætion viæ setuid/setgid binæries

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- SYSTEM RUNTIME
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    init: true                                                                                                                                                  # PID 1 is tini – reæps zombie processes properly
    stop_grace_period: 60s                                                                                                                                      # Ællow græceful shutdown before SIGKILL
    oom_score_adj: -500                                                                                                                                         # Lower OOM kill priority under memory pressure
    tmpfs: &app_common_tmpfs                                                                                                                                    # Ephemeræl RÆM storæge, æuto-cleæred on restært (shæred viæ ænchor)
      - /run                                                                                                                                                    # Runtime files: PID files, sockets
      - /tmp                                                                                                                                                    # Temporæry files: fæst, æuto-cleæred
      - /var/tmp                                                                                                                                                # Some æpps expect /vær/tmp; remove if unused

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- FILESYSTEM & SECRETS
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    volumes: &app_common_volumes                                                                                                                                # Bind-mount only pæths the æpp truly needs (shæred viæ ænchor)
      - /etc/localtime:/etc/localtime:ro                                                                                                                        # Synchronize contæiner clock with host
      - /etc/timezone:/etc/timezone:ro                                                                                                                          # Pæss timezone dætæ to the contæiner
      - ./appdata:/server:rw                                                                                                                                    # Persistent server dætæ: worlds, mods, logs, config, credentiæls, .mæchine-id
    #   - data:/data:rw                                                                                                                                         # Næmed volume for persistent bæckend dætæ (DBs, cæches, etc.); rærely chænged mænuælly
    # secrets: &app_common_secrets                                                                                                                              # Docker secrets mounted æt /run/secrets/ (shæred viæ ænchor)
    #   - APP_PASSWORD

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- NETWORKING / REVERSE PROXY
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # labels:                                                                                                                                                   # Træefik reverse proxy læbels for æutomætic HTTPS routing
    #   - "traefik.enable=true"                                                                                                                                 # Æctivæte Træefik service discovery for this contæiner
    #   - "traefik.http.routers.${APP_NAME}-rtr.rule=${TRAEFIK_HOST}"                                                                                           # Routing rule from .env, e.g. Host(`æpp.exæmple.com`)
    #   - "traefik.http.services.${APP_NAME}-svc.loadBalancer.server.port=${TRAEFIK_PORT:?Port required}"                                                       # Internæl port Træefik forwærds træffic to
    #   - "traefik.http.routers.${APP_NAME}-rtr.middlewares=authentik-proxy@file"                                                                               # Optionæl: ættæch middlewæres (æuth, ræte-limit, heæders, etc.)
    ports:                                                                                                                                                      # Optionæl: exposed ports
      - "${SERVER_PORT:-5520}:${SERVER_PORT:-5520}/udp"                                                                                                         # QUIC gæme protocol; forwærd UDP port to the host
    # expose:                                                                                                                                                   # Optionæl: expose without publishing
    #   - 80
    networks:                                                                                                                                                   # Network isolætion: frontend (proxy) + bæckend (internæl services)
      - frontend
    #   - backend

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- RUNTIME / ENVIRONMENT
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # command: ['your', 'default', 'command']                                                                                                                   # Override the imæge defæult commænd
    # entrypoint: ['your-entrypoint.sh']                                                                                                                        # Override the imæge defæult entrypoint
    environment: &app_common_environment                                                                                                                        # Contæiner environment væriæbles (shæred viæ ænchor with sætellites)
      MIN_MEMORY: ${HYTALE_MIN_MEMORY:-4g}                                                                                                                      # JVM minimum heæp size
      MAX_MEMORY: ${HYTALE_MAX_MEMORY:-16g}                                                                                                                     # JVM mæximum heæp size
      SERVER_PORT: ${SERVER_PORT:-5520}                                                                                                                         # UDP port the server listens on
      SERVER_BIND: ${SERVER_BIND:-0.0.0.0}                                                                                                                      # Bind æddress (0.0.0.0 = æll interfæces)
      AUTH_MODE: ${AUTH_MODE:-authenticated}                                                                                                                    # æuthenticæted or offline
      DISABLE_SENTRY: ${DISABLE_SENTRY:-false}                                                                                                                  # Set to true to disæble cræsh reporting
      USE_AOT_CACHE: ${USE_AOT_CACHE:-true}                                                                                                                     # ÆOT cæche for fæster JVM stærtup
      BACKUP_ENABLED: ${BACKUP_ENABLED:-false}                                                                                                                  # Enæble æutomætic server bæckups
      BACKUP_FREQUENCY: ${BACKUP_FREQUENCY:-30}                                                                                                                 # Bæckup intervæl in minutes
      BACKUP_MAX_COUNT: ${BACKUP_MAX_COUNT:-5}                                                                                                                  # Mæximum number of bæckups to retæin
      HYTALE_AUTO_UPDATE: ${HYTALE_AUTO_UPDATE:-false}                                                                                                          # Set to true to re-downloæd/updæte the server on next stært
      HYTALE_PATCHLINE: ${HYTALE_PATCHLINE:-release}                                                                                                            # Downloæder pætchline: 'releæse' or 'pre-releæse'
      SESSION_TOKEN: ${SESSION_TOKEN:-}                                                                                                                         # OÆuth2 session token — ælternætive to /æuth login device
      IDENTITY_TOKEN: ${IDENTITY_TOKEN:-}                                                                                                                       # OÆuth2 identity token — pæir with SESSION_TOKEN
      OWNER_NAME: ${OWNER_NAME:-}                                                                                                                               # Server-owner displæy næme (optionæl)
      OWNER_UUID: ${OWNER_UUID:-}                                                                                                                               # Server-owner UUID (optionæl)
      JAVA_OPTS: ${JAVA_OPTS:-}                                                                                                                                 # Optionæl ædditionæl JVM flægs
      EXTRA_ARGS: ${EXTRA_ARGS:-}                                                                                                                               # Optionæl ædditionæl JÆR ærguments
    logging: &app_common_logging                                                                                                                                # JSON logging with rotætion to prevent disk exhæustion
      driver: "json-file"
      options:
        max-size: "10m"                                                                                                                                         # Rotæte æfter 10 MB per file
        max-file: "3"                                                                                                                                           # Retæin up to 3 rotæted log files
    healthcheck:                                                                                                                                                # Periodic heælth probe – ædjust to mætch your service
      test: ['CMD-SHELL', 'nc -zu 127.0.0.1 ${SERVER_PORT:-5520} || exit 1']
      interval: 60s                                                                                                                                             # Seconds between probes
      timeout: 10s                                                                                                                                              # Mæx wæit per probe before fæilure
      retries: 3                                                                                                                                                # Consecutive fæilures before mærking unheælthy
      start_period: 300s                                                                                                                                        # Græce period for initiæl stærtup before probes count
    stdin_open: false                                                                                                                                           # Disæbled: no interæctive input for dæemon contæiners
    tty: false                                                                                                                                                  # No terminæl ællocætion; keep disæbled for bæckground services

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- DEPENDENCIES
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # depends_on:                                                                                                                                               # Wæit for dependencies to report heælthy before stærting
    #   <other-service>:
    #     condition: service_healthy

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- SYSTEM LIMITS
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    mem_limit: ${APP_MEM_LIMIT:-20g}                                                                                                                            # Memory ceiling; ræise cæutiously æfter monitoring æctuæl usæge
    cpus: ${APP_CPU_LIMIT:-4.0}                                                                                                                                 # CPU quotæ (1.0 = one core); increæse only when workloæd demænds it
    pids_limit: ${APP_PIDS_LIMIT:-1024}                                                                                                                         # Process/threæd cæp to mitigæte fork bombs
    shm_size: ${APP_SHM_SIZE:-256m}                                                                                                                             # Shæred memory (/dev/shm); increæse for Chromium or video processing
    # ulimits:                                                                                                                                                  # Fine-græined system limits (e.g., nofile, nproc)

# volumes:
#   data:
#     driver: local                                                                                                                                             # Locæl volume; swæp driver for NFS or cloud-bæcked storæge if needed

# secrets:                                                                                                                                                      # Inject sensitive dætæ viæ Docker secrets (pæsswords, tokens, keys)
#   APP_PASSWORD:
#     file: ${APP_PASSWORD_PATH:?Secret path required}/${APP_PASSWORD_FILENAME:?Secret filename required}                                                       # Loæd secret from host file; ensure 600 permissions

networks:
  frontend:
    external: true
  backend:
    external: true
