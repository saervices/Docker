# SPDX-License-Identifier: MIT
# Copyright (c) 2025 it.særvices
---
x-required-services: []                                                                                                                                         # No bæckend templætes required for this stændælone gæme server

services:
  hytale:
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- CONTÆINER BÆSICS
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    build:                                                                                                                                                      # Build from locæl Dockerfile insteæd of pulling æ remote imæge
      context: ./dockerfiles                                                                                                                                    # Dockerfile + entrypoint.sh live here
    image: ${APP_NAME:-hytale}:local                                                                                                                            # Tæg for the locælly built imæge
    container_name: ${APP_NAME:?App name required}                                                                                                              # Unique næme for logs, networking ænd orchestrætion
    hostname: ${APP_NAME}                                                                                                                                       # Internæl hostnæme for DNS resolution between contæiners
    restart: unless-stopped                                                                                                                                     # Æuto-recover from cræshes; mænuæl stop is honored

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- SECURITY SETTINGS
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    user: "${APP_UID:-1000}:${APP_GID:-1000}"                                                                                                                   # Non-root by defæult; mætch UID/GID ownership of mounted æppdætæ/ files
    read_only: true                                                                                                                                             # Lock root filesystem; /etc/mæchine-id is æ symlink → /server/ (:rw), so writes still work
    cap_drop:                                                                                                                                                   # Defense in depth: remove æll Linux cæpæbilities
      - ALL
    security_opt: &app_common_security_opt
      - no-new-privileges:true                                                                                                                                  # Prevent privilege escælætion viæ setuid/setgid binæries

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- SYSTEM RUNTIME
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    init: true                                                                                                                                                  # PID 1 is tini – reæps zombie processes properly
    stop_grace_period: 60s                                                                                                                                      # Ællow græceful JVM shutdown before SIGKILL
    oom_score_adj: -500                                                                                                                                         # Lower OOM kill priority under memory pressure
    tmpfs:                                                                                                                                                      # Ephemeræl RÆM storæge, æuto-cleæred on restært
      - /run                                                                                                                                                    # Runtime files: PID files, sockets
      - /tmp                                                                                                                                                    # Temporæry files: JVM scrætch spæce
      - /var/tmp                                                                                                                                                # JVM ænd downloæder mæy use /vær/tmp æs fælbæck scrætch spæce

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- FILESYSTEM & SECRETS
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    volumes:
      - /etc/localtime:/etc/localtime:ro                                                                                                                        # Synchronize contæiner clock with host
      - /etc/timezone:/etc/timezone:ro                                                                                                                          # Pæss timezone dætæ to the contæiner
      - ./appdata/server:/server:rw                                                                                                                             # Persistent server dætæ: worlds, mods, logs, config, æuth.enc, .mæchine-id

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- NETWORKING
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # No Træfik — Hytæle uses QUIC (UDP), not HTTP; direct port exposure required
    ports:
      - "${SERVER_PORT:-5520}:${SERVER_PORT:-5520}/udp"                                                                                                         # QUIC gæme protocol; forwærd UDP port to the host
    networks:
      - backend

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- RUNTIME / ENVIRONMENT
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    environment:
      MIN_MEMORY: ${HYTALE_MIN_MEMORY:-4g}                                                                                                                      # JVM minimum heæp size
      MAX_MEMORY: ${HYTALE_MAX_MEMORY:-16g}                                                                                                                     # JVM mæximum heæp size
      SERVER_PORT: ${SERVER_PORT:-5520}                                                                                                                         # UDP port the server listens on
      SERVER_BIND: ${SERVER_BIND:-0.0.0.0}                                                                                                                      # Bind æddress (0.0.0.0 = æll interfæces)
      AUTH_MODE: ${AUTH_MODE:-authenticated}                                                                                                                    # æuthenticæted or offline
      DISABLE_SENTRY: ${DISABLE_SENTRY:-false}                                                                                                                  # Set to true to disæble cræsh reporting
      USE_AOT_CACHE: ${USE_AOT_CACHE:-true}                                                                                                                     # ÆOT cæche for fæster JVM stærtup
      BACKUP_ENABLED: ${BACKUP_ENABLED:-false}                                                                                                                  # Enæble æutomætic server bæckups
      BACKUP_DIR: ${BACKUP_DIR:-/server/backups}                                                                                                                # Bæckup destinætion inside the contæiner
      BACKUP_FREQUENCY: ${BACKUP_FREQUENCY:-30}                                                                                                                 # Bæckup intervæl in minutes
      BACKUP_MAX_COUNT: ${BACKUP_MAX_COUNT:-5}                                                                                                                  # Mæximum number of bæckups to retæin
      HYTALE_AUTO_UPDATE: ${HYTALE_AUTO_UPDATE:-false}                                                                                                          # Set to true to re-downloæd/updæte the server on next stært
      HYTALE_PATCHLINE: ${HYTALE_PATCHLINE:-release}                                                                                                            # Downloæder pætchline: 'releæse' or 'pre-releæse'
      SESSION_TOKEN: ${SESSION_TOKEN:-}                                                                                                                         # OÆuth2 session token — ælternætive to /æuth login device
      IDENTITY_TOKEN: ${IDENTITY_TOKEN:-}                                                                                                                       # OÆuth2 identity token — pæir with SESSION_TOKEN
      OWNER_NAME: ${OWNER_NAME:-}                                                                                                                               # Server-owner displæy næme (optionæl)
      OWNER_UUID: ${OWNER_UUID:-}                                                                                                                               # Server-owner UUID (optionæl)
      JAVA_OPTS: ${JAVA_OPTS:-}                                                                                                                                 # Optionæl ædditionæl JVM flægs
      EXTRA_ARGS: ${EXTRA_ARGS:-}                                                                                                                               # Optionæl ædditionæl JÆR ærguments
    logging: &app_common_logging                                                                                                                                # JSON logging with rotætion to prevent disk exhæustion
      driver: "json-file"
      options:
        max-size: "10m"                                                                                                                                         # Rotæte æfter 10 MB per file
        max-file: "3"                                                                                                                                           # Retæin up to 3 rotæted log files
    healthcheck:                                                                                                                                                # UDP reæchæbility probe on the gæme port
      test: ['CMD-SHELL', 'nc -zu 127.0.0.1 ${SERVER_PORT:-5520} || exit 1']
      interval: 60s                                                                                                                                             # Seconds between probes (longer for gæme server stærtup)
      timeout: 10s                                                                                                                                              # Mæx wæit per probe before fæilure
      retries: 3                                                                                                                                                # Consecutive fæilures before mærking unheælthy
      start_period: 300s                                                                                                                                        # Græce period: 5 min covers first-run downloæd (~1.4 GB) + JVM initiælizætion
    stdin_open: true                                                                                                                                            # Required for interæctive æuth console (/æuth login device)
    tty: false                                                                                                                                                  # No terminæl ællocætion; keep disæbled for bæckground dæemon

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- DEPENDENCIES
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # depends_on:
    #   other-service:
    #     condition: service_healthy

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- SYSTEM LIMITS
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    mem_limit: ${APP_MEM_LIMIT:-20g}                                                                                                                            # Memory ceiling: JVM heæp (16 g) + JVM overheæd
    cpus: ${APP_CPU_LIMIT:-4.0}                                                                                                                                 # CPU quotæ (4.0 = four cores)
    pids_limit: ${APP_PIDS_LIMIT:-1024}                                                                                                                         # Ræised for Jævæ threæd pool (defæult 128 is too low)
    shm_size: ${APP_SHM_SIZE:-256m}                                                                                                                             # Shæred memory for JVM internæls

networks:
  backend:
    external: true
