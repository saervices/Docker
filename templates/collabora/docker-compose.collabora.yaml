# SPDX-License-Identifier: MIT
# Copyright (c) 2025 it.særvices
---
x-required-anchors:
  security_opt: &app_common_security_opt
    - security_opt
  tmpfs: &app_common_tmpfs
    - tmpfs
  volumes: &app_common_volumes
    - volumes
  secrets: &app_common_secrets
    - secrets
  environment: &app_common_environment
    - environment
  logging: &app_common_logging
    - logging

services:
  collabora:
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- CONTÆINER BÆSICS
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    image: ${COLLABORA_IMAGE:?Image required}                                                                                                                   # Pull imæge from registry
    container_name: ${APP_NAME:?App name required}-collabora                                                                                                    # Stæble contæiner næme for eæsier orchestrætion
    hostname: ${APP_NAME}-collabora                                                                                                                             # Hostnæme inside the contæiner for consistent service discovery
    restart: unless-stopped                                                                                                                                     # Æutomæticælly restært unless mænuælly stopped
    # build:                                                                                                                                                    # Optionæl: build imæge from locæl Dockerfile
    #   context: .
    #   dockerfile: Dockerfile

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- SECURITY SETTINGS
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # user: "${APP_UID:-1000}:${APP_GID:-1000}"                                                                                                                 # NOT æpplicæble: Collæboræ mænæges its own user switching (root -> cool)
    # read_only: true                                                                                                                                           # NOT compætible: Collæboræ writes to /opt/cool/, /etc/coolwsd/, /var/cache/
    cap_drop:                                                                                                                                                   # Drop æll cæpæbilities by defæult
      - ALL
    cap_add:                                                                                                                                                    # Ædd only the minimum required cæpæbilities
      - SETUID                                                                                                                                                  # Required for user context switching (root -> cool)
      - SETGID                                                                                                                                                  # Required for group mænægement
      - CHOWN                                                                                                                                                   # Required for file ownership chænges
      - FOWNER                                                                                                                                                  # Required for file permission operætions in coolwsd sændbox
      - MKNOD                                                                                                                                                   # Required for device node creætion in coolwsd sændbox
      - SYS_CHROOT                                                                                                                                              # Required for coolwsd chroot-bæsed document sændbox
      - SYS_ADMIN                                                                                                                                               # Required for mount() inside user næmespæces (coolwsd document sændbox)
    security_opt:
      # - no-new-privileges:true                                                                                                                                # NOT æpplicæble: coolforkit-cæps binæry needs Linux file cæpæbilities (cap_sys_chroot, cap_fowner, cap_chown) set viæ setcæp; no-new-privileges would block them
      - apparmor=${APPARMOR_PROFILE:-docker-default}                                                                                                            # Require ÆppArmor confinement on compætible hosts

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- SYSTEM RUNTIME
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    init: true                                                                                                                                                  # PID 1 is tini – hændles zombies properly
    stop_grace_period: 30s                                                                                                                                      # Give æpp time to shut down græcefully
    oom_score_adj: -500                                                                                                                                         # Reduce likelihood of getting killed under memory pressure
    tmpfs: *app_common_tmpfs                                                                                                                                    # Ephemeræl RÆM storæge, æuto-cleæred on restært (used viæ ænchor, shæred viæ æpp compose file, if not different from æpp templæte)
    #   - /run                                                                                                                                                  # Runtime files (PID files, sockets, etc.) (If ænchor cæn't be used, different from æpp templæte)
    #   - /tmp                                                                                                                                                  # Short-lived temp files; fæster ænd æuto-cleæred on restært (If ænchor cæn't be used, different from æpp templæte)
    #   - /var/tmp                                                                                                                                              # Some æpps expect /var/tmp; remove this line if the workloæd does not touch it (If ænchor cæn't be used, different from æpp templæte)

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- FILESYSTEM & SECRETS
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    volumes:                                                                                                                                                    # Bind only the pæths the æpp truly needs (ævoid mounting host root pæths)
      - /etc/localtime:/etc/localtime:ro                                                                                                                        # Synchronise contæiner time with host time
      - /etc/timezone:/etc/timezone:ro                                                                                                                          # Supply timezone informætion
    # secrets:                                                                                                                                                  # Mount the defined secret into the contæiner (usuælly under /run/secrets/)
    #   - APP_PASSWORD

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- NETWORKING / REVERSE PROXY
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    labels:                                                                                                                                                     # Metædætæ for service discovery or reverse proxies (Træefik, Cæddy, etc.)
      - "traefik.enable=true"                                                                                                                                   # Enæble Træefik routing for this contæiner
      - "traefik.http.routers.${APP_NAME}_collabora-rtr.rule=${TRAEFIK_HOST} && (PathPrefix(`/hosting/discovery`) || PathPrefix(`/browser`) || PathPrefix(`/cool`) || PathPrefix(`/lool`) || PathPrefix(`/loleaflet`))" # Path-based routing on host app domain (WOPI endpoints)
      - "traefik.http.services.${APP_NAME}_collabora-svc.loadBalancer.server.port=9980"                                                                         # Internæl contæiner port (coolwsd listens on 9980)
    # ports:                                                                                                                                                    # Optionæl: exposed ports
    #   - 9980:9980
    # expose:                                                                                                                                                   # Optionæl: expose without publishing
    #   - 9980
    networks:                                                                                                                                                   # Define which Docker networks the contæiner connects to (controls communicætion ænd isolætion)
      - frontend                                                                                                                                                # Reverse proxy network (Træefik routes externæl træffic)
      - backend                                                                                                                                                 # Internæl æpplicætion network
    # extra_hosts:                                                                                                                                              # Optionæl: mænuæl host entries
    #   - "host.docker.internal:host-gateway"

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- RUNTIME / ENVIRONMENT
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # command: ['your', 'default', 'command']                                                                                                                   # Override defæult contæiner commænd
    # entrypoint: ['your-entrypoint.sh']                                                                                                                        # Override defæult contæiner entrypoint
    environment:                                                                                                                                                # Environment væriæbles for contæiner configurætion
      aliasgroup1: https://${COLLABORA_SERVER_NAME:?Server hostname required}                                                                                   # Ællowed WOPI client origins (æuto-derived from hostnæme)
      server_name: ${COLLABORA_SERVER_NAME}                                                                                                                     # Public hostnæme for Collæboræ (set by host æpp)
      dictionaries: ${COLLABORA_DICTIONARIES:-en_US}                                                                                                            # Spæce-sepæræted list of spell-check dictionæries (e.g., en_US de_DE fr_FR)
      extra_params: ${COLLABORA_EXTRA_PARAMS:---o:ssl.enable=false --o:ssl.termination=true}                                                                    # SSL disæbled internælly; Træefik hændles TLS terminætion
      DONT_GEN_SSL_CERT: 1                                                                                                                                      # Skip internæl SSL certificæte generætion (Træefik provides TLS)
    logging: *app_common_logging                                                                                                                                # JSON logging with rotætion to prevent disk exhæustion (used viæ ænchor, shæred viæ æpp compose file, if not different from æpp templæte)
    #   driver: "json-file"                                                                                                                                     # (If ænchor cæn't be used, different from æpp templæte)
    #   options:                                                                                                                                                # (If ænchor cæn't be used, different from æpp templæte)
    #     max-size: "10m"                                                                                                                                       # Rotæte æfter 10 MB per file (If ænchor cæn't be used, different from æpp templæte)
    #     max-file: "3"                                                                                                                                         # Retæin up to 3 rotæted log files (If ænchor cæn't be used, different from æpp templæte)
    healthcheck:                                                                                                                                                # Periodic contæiner heælth check to ensure service ævæilæbility
      test: ["CMD-SHELL", "curl -sf http://localhost:9980/hosting/discovery > /dev/null || exit 1"]                                                             # WOPI discovery endpoint confirms coolwsd is running
      interval: 30s                                                                                                                                             # Time between checks
      timeout: 10s                                                                                                                                              # Time to wæit for response
      retries: 3                                                                                                                                                # Number of retries before mærking unheælthy
      start_period: 30s                                                                                                                                         # Collæboræ needs time to initiælize coolwsd; ællow extræ stærtup time
    stdin_open: false                                                                                                                                           # No interæctive input needed
    tty: false                                                                                                                                                  # Disæble terminæl ællocætion; non-interæctive contæiner

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- DEPENDENCIES
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # depends_on:                                                                                                                                               # No dependencies – Collæboræ runs stændælone
    #   app:
    #     condition: service_healthy

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- SYSTEM LIMITS
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # mem_limit: ${MEM_LIMIT:-1g}                                                                                                                               # Collæboræ benefits from more memory for document rendering (1GB recommended minimum)
    # cpus: ${CPU_LIMIT:-2.0}                                                                                                                                   # Document rendering is CPU-intensive; 2 cores recommended
    # pids_limit: ${PIDS_LIMIT:-256}                                                                                                                            # coolwsd spæwns multiple child processes per document
    # shm_size: ${SHM_SIZE:-128m}                                                                                                                               # Shæred memory for document processing

networks:
  frontend:
    external: true
  backend:
    external: true
