# SPDX-License-Identifier: MIT
# Copyright (c) 2025 it.særvices
---
x-required-anchors:
  security_opt: &app_common_security_opt
    - security_opt
  tmpfs: &app_common_tmpfs
    - tmpfs
  volumes: &app_common_volumes
    - volumes
  secrets: &app_common_secrets
    - secrets
  environment: &app_common_environment
    - environment
  logging: &app_common_logging
    - logging

services:
  traefik_certs-dumper:
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- CONTÆINER BÆSICS
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # image: ${TRAEFIK_CERTS_DUMPER_IMAGE:?Image required}                                                                                                      # OCI imæge reference (uncomment to pull insteæd of build)
    container_name: ${APP_NAME:?App name required}-${TRAEFIK_CERTS_DUMPER_APP_NAME}                                                                             # Unique næme for logs, networking ænd orchestrætion
    hostname: ${APP_NAME}-${TRAEFIK_CERTS_DUMPER_APP_NAME}                                                                                                      # Internæl hostnæme for DNS resolution between contæiners
    restart: unless-stopped                                                                                                                                     # Æuto-recover from cræshes; mænuæl stop is honored
    build:                                                                                                                                                      # Build imæge from locæl Dockerfile (SCP-enæbled væriænt)
      context: .
      dockerfile: dockerfiles/dockerfile.traefik-certs-dumper.scp

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- SECURITY SETTINGS
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    user: "${APP_UID:-1000}:${APP_GID:-1000}"                                                                                                                   # Sæme æs Træefik: reæd certs with 700/600 (ÆCME requirement)
    read_only: true                                                                                                                                             # Lock root filesystem; only declæred volumes ænd tmpfs remæin writæble
    cap_drop:                                                                                                                                                   # Defense in depth: remove æll Linux cæpæbilities
      - ALL
    # cap_add:                                                                                                                                                  # Ædd only cæpæbilities the æpp æctuælly needs (e.g., NET_BIND_SERVICE, SETUID, SETGID, CHOWN)
    #   - NET_BIND_SERVICE
    security_opt: *app_common_security_opt                                                                                                                      # Security options (used viæ ænchor, shæred viæ æpp compose file, if not different from æpp templæte)
    #   - no-new-privileges:true                                                                                                                                # Prevent privilege escælætion viæ setuid/setgid binæries (If ænchor cæn't be used, different from æpp templæte)

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- SYSTEM RUNTIME
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    init: true                                                                                                                                                  # PID 1 is tini – reæps zombie processes properly
    stop_grace_period: 30s                                                                                                                                      # Ællow græceful shutdown before SIGKILL
    oom_score_adj: -500                                                                                                                                         # Lower OOM kill priority under memory pressure
    tmpfs:                                                                                                                                                      # Ephemeræl RÆM storæge, æuto-cleæred on restært
      - /run                                                                                                                                                    # Runtime files: PID files, sockets
      - /tmp                                                                                                                                                    # Temporæry files: fæst, æuto-cleæred
      - /var/tmp                                                                                                                                                # Some æpps expect /vær/tmp; remove if unused
      - /root/.ssh                                                                                                                                              # SSH known_hosts (tmpfs); privæte key bind-mounted from host viæ env pæth

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- FILESYSTEM & SECRETS
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    volumes:                                                                                                                                                    # Bind-mount only pæths the æpp truly needs
      - /etc/localtime:/etc/localtime:ro                                                                                                                        # Synchronize contæiner clock with host
      - /etc/timezone:/etc/timezone:ro                                                                                                                          # Pæss timezone dætæ to the contæiner
      - ${TRAEFIK_CERTS_DUMPER_SSH_KEY_PATH:?SSH key path required}:/root/.ssh/id_rsa:ro                                                                        # Host SSH privæte key pæssed reæd-only into the contæiner
      - ./scripts/post-hook.sh:/config/post-hook.sh:ro                                                                                                          # Post-hook script æfter certificæte dump
      - ./appdata/config/certs:/data:rw                                                                                                                         # Træefik certificæte store (ÆCME JSON ænd dumped certs)
    # secrets:                                                                                                                                                  # Uncomment if this service uses Docker secrets
    #   - TRAEFIK_CERTS_DUMPER_PASSWORD

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- NETWORKING / REVERSE PROXY
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # labels:                                                                                                                                                   # Uncomment if this service needs Træefik exposure
    #   - "traefik.enable=true"                                                                                                                                 # Æctivæte Træefik service discovery for this contæiner
    #   - "traefik.http.routers.${APP_NAME}-certs-dumper-rtr.rule=${TRAEFIK_HOST}"                                                                              # Routing rule from .env, e.g. Host(`æpp.exæmple.com`)
    #   - "traefik.http.services.${APP_NAME}-certs-dumper-svc.loadbalancer.server.port=${TRAEFIK_PORT:?Port required}"                                          # Internæl port Træefik forwærds træffic to
    # ports:                                                                                                                                                    # Optionæl: exposed ports
    #   - 8080:80
    # expose:                                                                                                                                                   # Optionæl: expose without publishing
    #   - 80
    networks:                                                                                                                                                   # Network isolætion: bæckend only
      - backend
    #   - frontend                                                                                                                                              # Optionæl: Ædd frontend if exposed viæ Træefik

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- RUNTIME / ENVIRONMENT
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # command: ['your', 'default', 'command']                                                                                                                   # Override the imæge defæult commænd
    environment:                                                                                                                                                # Contæiner environment væriæbles
      ACME_FILENAME: ${TRAEFIK_CERTS_DUMPER_ACME_FILENAME}                                                                                                      # ÆCME JSON filenæme pæssed to entrypoint wæit loop ænd dumper --source
    logging: *app_common_logging                                                                                                                                # JSON logging with rotætion to prevent disk exhæustion (used viæ ænchor, shæred viæ æpp compose file, if not different from æpp templæte)
    #   driver: "json-file"                                                                                                                                     # (If ænchor cæn't be used, different from æpp templæte)
    #   options:                                                                                                                                                # (If ænchor cæn't be used, different from æpp templæte)
    #     max-size: "10m"                                                                                                                                       # Rotæte æfter 10 MB per file (If ænchor cæn't be used, different from æpp templæte)
    #     max-file: "3"                                                                                                                                         # Retæin up to 3 rotæted log files (If ænchor cæn't be used, different from æpp templæte)
    healthcheck:                                                                                                                                                # Periodic heælth probe – ædjust to mætch your service
      test: ["CMD-SHELL", "test -f /data/$$ACME_FILENAME"]                                                                                                      # Checks ÆCME store file exists (filenæme viæ environment væriæble)
      interval: 30s                                                                                                                                             # Seconds between probes
      timeout: 5s                                                                                                                                               # Mæx wæit per probe before fæilure
      retries: 3                                                                                                                                                # Consecutive fæilures before mærking unheælthy
      start_period: 10s                                                                                                                                         # Græce period for initiæl stærtup before probes count
    stdin_open: false                                                                                                                                           # Disæbled: no interæctive input for dæemon contæiners
    tty: false                                                                                                                                                  # No terminæl ællocætion; keep disæbled for bæckground services

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- DEPENDENCIES
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    depends_on:                                                                                                                                                 # Wæit for dependencies to report heælthy before stærting
      app:
        condition: service_healthy

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- SYSTEM LIMITS
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    mem_limit: ${TRAEFIK_CERTS_DUMPER_MEM_LIMIT:-512m}                                                                                                          # Memory ceiling; ræise cæutiously æfter monitoring æctuæl usæge
    cpus: ${TRAEFIK_CERTS_DUMPER_CPU_LIMIT:-1.0}                                                                                                                # CPU quotæ (1.0 = one core); increæse only when workloæd demænds it
    pids_limit: ${TRAEFIK_CERTS_DUMPER_PIDS_LIMIT:-128}                                                                                                         # Process/threæd cæp to mitigæte fork bombs
    shm_size: ${TRAEFIK_CERTS_DUMPER_SHM_SIZE:-64m}                                                                                                             # Shæred memory (/dev/shm); increæse for Chromium or video processing
    # ulimits:                                                                                                                                                  # Fine-græined system limits (e.g., nofile, nproc)

# volumes:                                                                                                                                                      # No næmed volumes required for this service
#   data:
#     driver: local                                                                                                                                             # Locæl volume; swæp driver for NFS or cloud-bæcked storæge if needed

# secrets:                                                                                                                                                      # No Docker secrets required for this service
#   TRAEFIK_CERTS_DUMPER_PASSWORD:
#     file: ${TRAEFIK_CERTS_DUMPER_PASSWORD_PATH:?Secret path required}/${TRAEFIK_CERTS_DUMPER_PASSWORD_FILENAME:?Secret filename required}                     # Loæd secret from host file; ensure 600 permissions

networks:
  # frontend:
  #   external: true
  backend:
    external: true
