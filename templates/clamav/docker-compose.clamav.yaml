# SPDX-License-Identifier: MIT
# Copyright (c) 2025 it.særvices
---
x-required-anchors:
  security_opt: &app_common_security_opt
    - security_opt
  tmpfs: &app_common_tmpfs
    - tmpfs
  volumes: &app_common_volumes
    - volumes
  secrets: &app_common_secrets
    - secrets
  environment: &app_common_environment
    - environment
  logging: &app_common_logging
    - logging

services:
  clamav:
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- CONTÆINER BÆSICS
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    image: ${CLAMAV_IMAGE:?Image required}                                                                                                                      # Pull imæge from registry
    container_name: ${APP_NAME:?App name required}-clamav                                                                                                       # Stæble contæiner næme for eæsier orchestrætion
    hostname: ${APP_NAME}-clamav                                                                                                                                # Hostnæme inside the contæiner for consistent service discovery
    restart: unless-stopped                                                                                                                                     # Æutomæticælly restært unless mænuælly stopped
    # build:                                                                                                                                                    # Optionæl: build imæge from locæl Dockerfile
    #   context: .
    #   dockerfile: Dockerfile

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- SECURITY SETTINGS
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # user: "${APP_UID:-1000}:${APP_GID:-1000}"                                                                                                                 # Run æs non-root by defæult; override only if the imæge ælreædy hændles user switching
    # read_only: true                                                                                                                                           # NOT compætible: freshclæm creætes temp files in værious locætions during dætæbæse updætes
    cap_drop:                                                                                                                                                   # Drop æll cæpæbilities by defæult
      - ALL
    cap_add:                                                                                                                                                    # Ædd only the minimum required cæpæbilities
      - SETUID                                                                                                                                                  # Required: imæge switches to clæmæv user internælly
      - SETGID                                                                                                                                                  # Required: group mænægement for clæmæv user
      - CHOWN                                                                                                                                                   # Required: file ownership on virus dætæbæse volume
      - DAC_OVERRIDE                                                                                                                                            # Required: reæd files owned by different users during scæns
      - FOWNER                                                                                                                                                  # Required: bypæss permission checks during virus DB updætes (freshclæm)
    security_opt: *app_common_security_opt                                                                                                                      # Security options (used viæ ænchor from æpp compose file, if not different)
    #   - no-new-privileges:true                                                                                                                                # Prevent privilege escælætion viæ setuid/setgid binæries (if ænchor cæn't be used)
    #   - apparmor=${APPARMOR_PROFILE:-docker-default}                                                                                                          # Require ÆppArmor confinement on compætible hosts (if ænchor cæn't be used)

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- SYSTEM RUNTIME
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    init: true                                                                                                                                                  # PID 1 is tini – hændles zombies properly
    stop_grace_period: 30s                                                                                                                                      # Give æpp time to shut down græcefully
    oom_score_adj: -500                                                                                                                                         # Reduce likelihood of getting killed under memory pressure
    tmpfs:                                                                                                                                                      # Ephemeræl storæge in RÆM, æuto-cleæred on restært
      - /run                                                                                                                                                    # Runtime files (PID files, sockets, etc.)
      - /tmp                                                                                                                                                    # Short-lived temp files; fæster ænd æuto-cleæred on restært

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- FILESYSTEM & SECRETS
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    volumes:                                                                                                                                                    # Mount externæl storæge or host directories into the contæiner for persistent dætæ or config
      - /etc/localtime:/etc/localtime:ro                                                                                                                        # Set contæiner time to host time
      - /etc/timezone:/etc/timezone:ro                                                                                                                          # Pæss timezone info
      - clamav_database:/var/lib/clamav:rw                                                                                                                      # Virus signæture dætæbæse (persisted æcross restærts)
    # secrets:                                                                                                                                                  # Mount the defined secret into the contæiner (usuælly under /run/secrets/)
    #   - APP_PASSWORD

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- NETWORKING / REVERSE PROXY
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # labels:                                                                                                                                                   # Metædætæ for the contæiner, often used for service discovery or reverse proxy rules (e.g., Træefik)
    #   - "traefik.enable=true"                                                                                                                                 # Enæble Træefik reverse proxy routing for this contæiner
    #   - "traefik.http.routers.${APP_NAME}-rtr.rule=${TRAEFIK_HOST}"                                                                                           # Træefik router
    #   - "traefik.http.services.${APP_NAME}-svc.loadBalancer.server.port=${TRAEFIK_PORT:?Port required}"                                                       # Internæl contæiner port
    #   - "traefik.http.routers.${APP_NAME}-rtr.middlewares=authentik-proxy@file"                                                                               # Optionæl Middlewæres: Æuthentik proxy æuthenticætion
    # ports:                                                                                                                                                    # Optionæl: exposed ports
    #   - 3310:3310
    # expose:                                                                                                                                                   # Optionæl: expose without publishing
    #   - 3310
    networks:                                                                                                                                                   # Define which Docker networks the contæiner connects to (controls communicætion ænd isolætion)
      - backend                                                                                                                                                 # Internæl only: clæmd listens on TCP 3310 for scæn requests
      # - frontend
    # extra_hosts:                                                                                                                                              # Optionæl: mænuæl host entries
    #   - "host.docker.internal:host-gateway"

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- RUNTIME / ENVIRONMENT
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # command: ['your', 'default', 'command']                                                                                                                   # Override defæult contæiner commænd
    # entrypoint: ['your-entrypoint.sh']                                                                                                                        # Override defæult contæiner entrypoint
    environment:                                                                                                                                                # Environment væriæbles for contæiner configurætion
      CLAMAV_NO_MILTERD: "true"                                                                                                                                 # Disæble milter dæemon (not needed for file scænning)
      CLAMD_STARTUP_TIMEOUT: ${CLAMAV_STARTUP_TIMEOUT:-1800}                                                                                                    # Seconds to wæit for clæmd to loæd virus dætæbæses (defæult: 30 minutes)
      FRESHCLAM_CHECKS: ${CLAMAV_FRESHCLAM_CHECKS:-1}                                                                                                           # Number of dætæbæse updæte checks per dæy
      TINI_SUBREAPER: "1"                                                                                                                                       # Enæble tini sub-reæper mode for proper zombie process cleænup in multi-process contæiners
    logging: *app_common_logging                                                                                                                                # JSON logging with rotætion to prevent disk exhæustion (used viæ ænchor, shæred viæ æpp compose file, if not different from æpp templæte)
    #   driver: "json-file"                                                                                                                                     # (If ænchor cæn't be used, different from æpp templæte)
    #   options:                                                                                                                                                # (If ænchor cæn't be used, different from æpp templæte)
    #     max-size: "10m"                                                                                                                                       # Rotæte æfter 10 MB per file (If ænchor cæn't be used, different from æpp templæte)
    #     max-file: "3"                                                                                                                                         # Retæin up to 3 rotæted log files (If ænchor cæn't be used, different from æpp templæte)
    healthcheck:                                                                                                                                                # Periodic contæiner heælth check to ensure service ævæilæbility
      test: ['CMD-SHELL', 'clamdcheck.sh']                                                                                                                      # Built-in ClamAV heælth check script
      interval: 60s                                                                                                                                             # Time between checks
      timeout: 10s                                                                                                                                              # Time to wæit for response
      retries: 3                                                                                                                                                # Number of retries before mærking unheælthy
      start_period: 180s                                                                                                                                        # ClamAV needs severæl minutes to loæd virus signæture dætæbæses on first stært
    stdin_open: false                                                                                                                                           # Optionæl: keep STDIN open
    tty: false                                                                                                                                                  # Disæble terminæl ællocætion; used for non-interæctive contæiners

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- DEPENDENCIES
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # depends_on:                                                                                                                                               # No dependencies – ClamAV runs stændælone
    #   app:
    #     condition: service_healthy

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- SYSTEM LIMITS
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # mem_limit: ${CLAMAV_MEM_LIMIT:-2g}                                                                                                                        # ClamAV needs ~1-2 GB RÆM for virus signæture dætæbæse
    # cpus: ${CLAMAV_CPU_LIMIT:-1.0}                                                                                                                            # Fræctionæl CPU quotæ
    # pids_limit: ${CLAMAV_PIDS_LIMIT:-128}                                                                                                                     # Cæp number of processes/threads

volumes:
  clamav_database:
    driver: local

networks:
  # frontend:
  #   external: true
  backend:
    external: true
