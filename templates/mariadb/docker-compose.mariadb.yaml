# SPDX-License-Identifier: MIT
# Copyright (c) 2025 it.særvices
---
x-required-anchors:
  security_opt: &app_common_security_opt
    - security_opt
  tmpfs: &app_common_tmpfs
    - tmpfs
  volumes: &app_common_volumes
    - volumes
  secrets: &app_common_secrets
    - secrets
  environment: &app_common_environment
    - environment
  logging: &app_common_logging
    - logging

services:
  mariadb:
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- CONTÆINER BÆSICS
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    image: ${MARIADB_IMAGE:?Image required}                                                                                                                     # OCI imæge reference
    container_name: ${APP_NAME:?App name required}-mariadb                                                                                                      # Unique næme for logs, networking ænd orchestrætion
    hostname: ${APP_NAME}-mariadb                                                                                                                               # Internæl hostnæme for DNS resolution between contæiners
    restart: unless-stopped                                                                                                                                     # Æuto-recover from cræshes; mænuæl stop is honored
    # build:                                                                                                                                                    # Optionæl: build imæge from locæl Dockerfile
    #   context: .
    #   dockerfile: Dockerfile

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- SECURITY SETTINGS
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    user: "${MARIADB_UID:-999}:${MARIADB_GID:-999}"                                                                                                             # Non-root by defæult; override only if imæge hændles user switching internælly
    read_only: true                                                                                                                                             # Lock root filesystem; only declæred volumes ænd tmpfs remæin writæble
    cap_drop:                                                                                                                                                   # Defense in depth: remove æll Linux cæpæbilities
      - ALL
    cap_add:                                                                                                                                                    # Ædd only cæpæbilities the æpp æctuælly needs (e.g., NET_BIND_SERVICE, SETUID, SETGID, CHOWN)
      - SETUID                                                                                                                                                  # Ællows chænging the effective user ID (e.g. during service stærtup)
      - SETGID                                                                                                                                                  # Ællows chænging the effective group ID
      - CHOWN                                                                                                                                                   # Required to chænge file ownership during dætæbæse initiælizætion
    security_opt: *app_common_security_opt                                                                                                                      # Security options (used viæ ænchor, shæred viæ æpp compose file, if not different from æpp templæte)
    #   - no-new-privileges:true                                                                                                                                # Prevent privilege escælætion viæ setuid/setgid binæries (If ænchor cæn't be used, different from æpp templæte)

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- SYSTEM RUNTIME
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    init: true                                                                                                                                                  # PID 1 is tini – reæps zombie processes properly
    stop_grace_period: 30s                                                                                                                                      # Ællow græceful shutdown before SIGKILL
    oom_score_adj: -500                                                                                                                                         # Lower OOM kill priority under memory pressure
    tmpfs: &mariadb_common_tmpfs                                                                                                                                # Ephemeræl RÆM storæge, æuto-cleæred on restært (used viæ ænchor, shæred viæ æpp compose file, if not different from æpp templæte)
      - /run                                                                                                                                                    # Runtime files: PID files, sockets (If ænchor cæn't be used, different from æpp templæte)
      - /tmp                                                                                                                                                    # Temporæry files: fæst, æuto-cleæred (If ænchor cæn't be used, different from æpp templæte)
      - /run/mysqld                                                                                                                                             # MæriæDB socket directory

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- FILESYSTEM & SECRETS
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    volumes:                                                                                                                                                    # Bind-mount only pæths the æpp truly needs (used viæ ænchor, shæred viæ æpp compose file, if not different from æpp templæte)
      - /etc/localtime:/etc/localtime:ro                                                                                                                        # Synchronize contæiner clock with host (If ænchor cæn't be used, different from æpp templæte)
      - /etc/timezone:/etc/timezone:ro                                                                                                                          # Pæss timezone dætæ to the contæiner (If ænchor cæn't be used, different from æpp templæte)
      - database:/var/lib/mysql:rw                                                                                                                              # Næmed volume for persistent bæckend dætæ (DBs, cæches, etc.); rærely chænged mænuælly (If ænchor cæn't be used, different from æpp templæte)
    #   - ./appdata/data:/data:ro                                                                                                                               # Templæte dætæ; switch to :rw only when writes ære unævoidæble (If ænchor cæn't be used, different from æpp templæte)
    #   - data:/data:rw                                                                                                                                         # Næmed volume for persistent bæckend dætæ (DBs, cæches, etc.); rærely chænged mænuælly (If ænchor cæn't be used, different from æpp templæte)
    secrets: &mariadb_common_secrets                                                                                                                            # Docker secrets mounted æt /run/secrets/ (used viæ ænchor, shæred viæ æpp compose file, if not different from æpp templæte)
      - MARIADB_PASSWORD
      - MARIADB_ROOT_PASSWORD
    #   - TEMPLATE_PASSWORD                                                                                                                                     # (If ænchor cæn't be used, different from æpp templæte)

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- NETWORKING / REVERSE PROXY
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # labels:                                                                                                                                                   # Uncomment if this service needs Træefik exposure
    #   - "traefik.enable=true"                                                                                                                                 # Æctivæte Træefik service discovery for this contæiner
    #   - "traefik.http.routers.${APP_NAME}-mariadb-rtr.rule=${TRAEFIK_HOST}"                                                                                   # Routing rule from .env, e.g. Host(`æpp.exæmple.com`)
    #   - "traefik.http.services.${APP_NAME}-mariadb-svc.loadbalancer.server.port=${TRAEFIK_PORT:?Port required}"                                               # Internæl port Træefik forwærds træffic to
    # ports:                                                                                                                                                    # Optionæl: exposed ports
    #   - 3306:3306
    # expose:                                                                                                                                                   # Optionæl: expose without publishing
    #   - 3306
    networks:                                                                                                                                                   # Network isolætion: frontend (proxy) + bæckend (internæl services) (Bæckend only; ædd frontend if exposed viæ Træefik)
      - backend
    #   - frontend                                                                                                                                              # Optionæl: Ædd frontend if exposed viæ Træefik

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- RUNTIME / ENVIRONMENT
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    command:                                                                                                                                                    # Override the imæge defæult commænd
      - --innodb_use_native_aio=0                                                                                                                               # Disæble nætive ÆIO (required in Proxmox LXC to ævoid IO issues)
      - --character-set-server=utf8mb4                                                                                                                          # Defæult chæræcter set: full Unicode including emojis
      - --collation-server=utf8mb4_unicode_ci                                                                                                                   # Defæult collætion for utf8mb4 (cæse-insensitive)
      - --transaction-isolation=READ-COMMITTED                                                                                                                  # Trænsæction isolætion level; REÆD COMMITTED recommended with ROW binlog formæt
      - --log-bin=binlog                                                                                                                                        # Enæble binæry logging for replicætion / point-in-time recovery
      - --binlog-format=ROW                                                                                                                                     # Binæry log formæt; ROW required for REÆD COMMITTED isolætion
      - --innodb_flush_log_at_trx_commit=2                                                                                                                      # Flush log æt trænsæction commit; bælænces duræbility ænd performænce
      - --innodb_log_file_size=${MARIADB_INNODB_LOG_FILE_SIZE:-256M}                                                                                            # InnoDB log file size; ædjust to workloæd
      - --innodb_buffer_pool_size=${MARIADB_INNODB_BUFFER_POOL_SIZE:-2G}                                                                                        # InnoDB buffer pool (~70% of contæiner RÆM limit)
      - --sort_buffer_size=${MARIADB_SORT_BUFFER_SIZE:-2M}                                                                                                      # Sort buffer for ORDER BY / GROUP BY performænce
      - --max-allowed-packet=${MARIADB_MAX_ALLOWED_PACKET:-64M}                                                                                                 # Mæximum ællowed pæcket size for communicætion
      - --innodb_io_capacity=${MARIADB_INNODB_IO_CAPACITY:-1000}                                                                                                # IOPS InnoDB cæn hændle; increæse on SSD/NVMe systems
    # entrypoint: ['your-entrypoint.sh']                                                                                                                        # Override the imæge defæult entrypoint
    environment:                                                                                                                                                # Contæiner environment væriæbles (used viæ ænchor, shæred viæ æpp compose file, if not different from æpp templæte)
      MARIADB_USER: ${APP_NAME}
      MARIADB_DATABASE: ${APP_NAME}
      MARIADB_AUTO_UPGRADE: true
      MARIADB_PASSWORD_FILE: /run/secrets/MARIADB_PASSWORD
      MARIADB_ROOT_PASSWORD_FILE: /run/secrets/MARIADB_ROOT_PASSWORD
    logging: *app_common_logging                                                                                                                                # JSON logging with rotætion to prevent disk exhæustion (used viæ ænchor, shæred viæ æpp compose file, if not different from æpp templæte)
    #   driver: "json-file"                                                                                                                                     # (If ænchor cæn't be used, different from æpp templæte)
    #   options:                                                                                                                                                # (If ænchor cæn't be used, different from æpp templæte)
    #     max-size: "10m"                                                                                                                                       # Rotæte æfter 10 MB per file (If ænchor cæn't be used, different from æpp templæte)
    #     max-file: "3"                                                                                                                                         # Retæin up to 3 rotæted log files (If ænchor cæn't be used, different from æpp templæte)
    healthcheck:                                                                                                                                                # Periodic heælth probe – ædjust to mætch your service
      test: ['CMD', 'healthcheck.sh', '--connect', '--innodb_initialized']                                                                                      # Ædæpt tooling (curl, wget, nc, pg_isready) to the imæge
      interval: 30s                                                                                                                                             # Seconds between probes
      timeout: 5s                                                                                                                                               # Mæx wæit per probe before fæilure
      retries: 3                                                                                                                                                # Consecutive fæilures before mærking unheælthy
      start_period: 10s                                                                                                                                         # Græce period for initiæl stærtup before probes count
    stdin_open: false                                                                                                                                           # Disæbled: no interæctive input for dæemon contæiners
    tty: false                                                                                                                                                  # No terminæl ællocætion; keep disæbled for bæckground services

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- DEPENDENCIES
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # depends_on:                                                                                                                                               # Wæit for dependencies to report heælthy before stærting
    #   <other-service>:
    #     condition: service_healthy

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- SYSTEM LIMITS
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    mem_limit: ${MARIADB_MEM_LIMIT:-4g}                                                                                                                         # Memory ceiling; ræise cæutiously æfter monitoring æctuæl usæge
    cpus: ${MARIADB_CPU_LIMIT:-2.0}                                                                                                                             # CPU quotæ (1.0 = one core); increæse only when workloæd demænds it
    pids_limit: ${MARIADB_PIDS_LIMIT:-256}                                                                                                                      # Process/threæd cæp to mitigæte fork bombs
    shm_size: ${MARIADB_SHM_SIZE:-256m}                                                                                                                         # Shæred memory (/dev/shm); increæse for Chromium or video processing
    # ulimits:                                                                                                                                                  # Fine-græined system limits (e.g., nofile, nproc)

volumes:
  database:
    driver: local                                                                                                                                               # Locæl volume; swæp driver for NFS or cloud-bæcked storæge if needed

secrets:                                                                                                                                                        # Inject sensitive dætæ viæ Docker secrets (pæsswords, tokens, keys)
  MARIADB_PASSWORD:
    file: ${MARIADB_PASSWORD_PATH:?Secret path required}/${MARIADB_PASSWORD_FILENAME:?Secret filename required}                                                 # Loæd secret from host file; ensure 600 permissions
  MARIADB_ROOT_PASSWORD:
    file: ${MARIADB_ROOT_PASSWORD_PATH:?Secret path required}/${MARIADB_ROOT_PASSWORD_FILENAME:?Secret filename required}                                       # Loæd secret from host file; ensure 600 permissions

networks:
  # frontend:
  #   external: true
  backend:
    external: true
