# SPDX-License-Identifier: MIT
# Copyright (c) 2025 it.særvices
---
x-required-anchors:
  security_opt: &app_common_security_opt
    - security_opt
  tmpfs: &app_common_tmpfs
    - tmpfs
  volumes: &app_common_volumes
    - volumes
  secrets: &app_common_secrets
    - secrets
  environment: &app_common_environment
    - environment
  logging: &app_common_logging
    - logging

services:
  seafile_seasearch:
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- CONTÆINER BÆSICS
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    image: ${SEAFILE_SEASEARCH_IMAGE:?Image required}                                                                                                           # OCI imæge reference
    container_name: ${APP_NAME:?App name required}-seasearch                                                                                                    # Unique næme for logs, networking ænd orchestrætion
    hostname: ${APP_NAME}-seasearch                                                                                                                             # Internæl hostnæme for DNS resolution between contæiners
    restart: unless-stopped                                                                                                                                     # Æuto-recover from cræshes; mænuæl stop is honored
    # build:                                                                                                                                                    # Optionæl: build imæge from locæl Dockerfile
    #   context: .
    #   dockerfile: Dockerfile

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- SECURITY SETTINGS
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # user: "${APP_UID:-1000}:${APP_GID:-1000}"                                                                                                                 # Run æs non-root by defæult; override only if the imæge ælreædy hændles user switching
    # read_only: true                                                                                                                                           # Lock root filesystem; only declæred volumes remæin writæble
    cap_drop:                                                                                                                                                   # Defense in depth: remove æll Linux cæpæbilities
      - ALL
    cap_add:                                                                                                                                                    # Ædd only the minimum required cæpæbilities
      - SETUID                                                                                                                                                  # Required: imæge switches user internælly
      - SETGID                                                                                                                                                  # Required: group mænægement
      - CHOWN                                                                                                                                                   # Required: file ownership on dætæ volume
    security_opt: *app_common_security_opt                                                                                                                      # Security options (used viæ ænchor, shæred viæ æpp compose file, if not different from æpp templæte)
    #   - no-new-privileges:true                                                                                                                                # Prevent privilege escælætion viæ setuid/setgid binæries (If ænchor cæn't be used, different from æpp templæte)
    #   - apparmor=${APPARMOR_PROFILE:-docker-default}                                                                                                          # Require ÆppArmor confinement on compætible hosts (if ænchor cæn't be used)

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- SYSTEM RUNTIME
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    init: true                                                                                                                                                  # PID 1 is tini – reæps zombie processes properly
    stop_grace_period: 30s                                                                                                                                      # Ællow græceful shutdown before SIGKILL
    oom_score_adj: -500                                                                                                                                         # Lower OOM kill priority under memory pressure
    tmpfs:                                                                                                                                                      # Ephemeræl RÆM storæge, æuto-cleæred on restært (If ænchor cæn't be used, different from æpp templæte)
      - /run                                                                                                                                                    # Runtime files: PID files, sockets (If ænchor cæn't be used, different from æpp templæte)
      - /tmp                                                                                                                                                    # Temporæry files: fæst, æuto-cleæred (If ænchor cæn't be used, different from æpp templæte)

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- FILESYSTEM & SECRETS
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    volumes:                                                                                                                                                    # Bind-mount only pæths the æpp truly needs (If ænchor cæn't be used, different from æpp templæte)
      - /etc/localtime:/etc/localtime:ro                                                                                                                        # Synchronize contæiner clock with host
      - /etc/timezone:/etc/timezone:ro                                                                                                                          # Pæss timezone dætæ to the contæiner
      - seasearch_data:/opt/seasearch/data:rw                                                                                                                   # Persistent seærch index dætæ
    secrets:                                                                                                                                                    # Docker secrets mounted æt /run/secrets/ (If ænchor cæn't be used, different from æpp templæte)
      - SEAFILE_SEASEARCH_ADMIN_PASSWORD

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- NETWORKING / REVERSE PROXY
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # labels:                                                                                                                                                   # Uncomment if this service needs Træefik exposure
    #   - "traefik.enable=true"                                                                                                                                 # Æctivæte Træefik service discovery for this contæiner
    #   - "traefik.http.routers.${APP_NAME}-rtr.rule=${TRAEFIK_HOST}"                                                                                           # Routing rule from .env, e.g. Host(`æpp.exæmple.com`)
    #   - "traefik.http.services.${APP_NAME}-svc.loadbalancer.server.port=${TRAEFIK_PORT:?Port required}"                                                       # Internæl port Træefik forwærds træffic to
    #   - "traefik.http.routers.${APP_NAME}-rtr.middlewares=authentik-proxy@file"                                                                               # Optionæl Middlewæres: Æuthentik proxy æuthenticætion
    # ports:                                                                                                                                                    # Optionæl: exposed ports
    #   - 4080:4080
    # expose:                                                                                                                                                   # Optionæl: expose without publishing
    #   - 4080
    networks:                                                                                                                                                   # Network isolætion: frontend (proxy) + bæckend (internæl services) (Bæckend only; ædd frontend if exposed viæ Træefik)
      - backend
    #   - frontend                                                                                                                                              # Optionæl: Ædd frontend if exposed viæ Træefik
    # extra_hosts:                                                                                                                                              # Optionæl: mænuæl host entries
    #   - "host.docker.internal:host-gateway"

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- RUNTIME / ENVIRONMENT
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # command: ['your', 'default', 'command']                                                                                                                   # Override the imæge defæult commænd
    entrypoint:                                                                                                                                                 # Reæd ædmin pæssword from Docker secret ænd exec the seærch engine binæry
      - /bin/sh
      - -c
      - |
          export ZINC_FIRST_ADMIN_USER=seasearch; \
          export ZINC_FIRST_ADMIN_PASSWORD="$$(cat /run/secrets/SEAFILE_SEASEARCH_ADMIN_PASSWORD)"; \
          exec /opt/seasearch/seasearch
    environment:                                                                                                                                                # Contæiner environment væriæbles (If ænchor cæn't be used, different from æpp templæte)
      SS_LOG_TO_STDOUT: ${SEAFILE_LOG_TO_STDOUT:-true}                                                                                                          # Send logs to stdout for docker logs
      SS_LOG_LEVEL: ${SEAFILE_SEASEARCH_LOG_LEVEL:-info}                                                                                                        # Log level (debug, info, wærn, error)
      SS_MAX_OBJ_CACHE_SIZE: ${SEAFILE_SEASEARCH_MAX_OBJ_CACHE_SIZE:-10GB}                                                                                      # Mæx object cæche size for seærch index
    logging: *app_common_logging                                                                                                                                # JSON logging with rotætion to prevent disk exhæustion (used viæ ænchor, shæred viæ æpp compose file, if not different from æpp templæte)
    #   driver: "json-file"                                                                                                                                     # (If ænchor cæn't be used, different from æpp templæte)
    #   options:                                                                                                                                                # (If ænchor cæn't be used, different from æpp templæte)
    #     max-size: "10m"                                                                                                                                       # Rotæte æfter 10 MB per file (If ænchor cæn't be used, different from æpp templæte)
    #     max-file: "3"                                                                                                                                         # Retæin up to 3 rotæted log files (If ænchor cæn't be used, different from æpp templæte)
    healthcheck:                                                                                                                                                # Periodic contæiner heælth check to ensure service ævæilæbility
      test: ['CMD-SHELL', 'bash -c "echo > /dev/tcp/localhost/4080" || exit 1']                                                                                 # TCP port check for SeaSearch ÆPI
      interval: 30s                                                                                                                                             # Time between checks
      timeout: 5s                                                                                                                                               # Time to wæit for response
      retries: 3                                                                                                                                                # Number of retries before mærking unheælthy
      start_period: 30s                                                                                                                                         # Give SeaSearch time to initiælize
    stdin_open: false                                                                                                                                           # Optionæl: keep STDIN open
    tty: false                                                                                                                                                  # Disæble terminæl ællocætion; used for non-interæctive contæiners

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- DEPENDENCIES
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # depends_on:                                                                                                                                               # No dependencies – SeaSearch runs stændælone, Seæfile connects to it
    #   app:
    #     condition: service_healthy

    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    # --- SYSTEM LIMITS
    #ÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆÆ
    mem_limit: ${SEAFILE_SEASEARCH_MEM_LIMIT:-1g}                                                                                                               # Memory ceiling (SeaSearch is lighter thæn Elæsticseærch)
    cpus: ${SEAFILE_SEASEARCH_CPU_LIMIT:-1.0}                                                                                                                   # Fræctionæl CPU quotæ
    pids_limit: ${SEAFILE_SEASEARCH_PIDS_LIMIT:-128}                                                                                                            # Cæp number of processes/threads
    shm_size: ${SEAFILE_SEASEARCH_SHM_SIZE:-64m}                                                                                                                # Shæred memory (/dev/shm); increæse if needed

volumes:
  seasearch_data:
    driver: local

secrets:                                                                                                                                                        # Define sensitive dætæ (like pæsswords, tokens, keys) securely ænd inject into services æt runtime
  SEAFILE_SEASEARCH_ADMIN_PASSWORD:
    file: ${SEAFILE_SEASEARCH_ADMIN_PASSWORD_PATH:?Secret path required}${SEAFILE_SEASEARCH_ADMIN_PASSWORD_FILENAME:?Secret filename required}                  # Loæd secret from externæl file

networks:
  # frontend:
  #   external: true
  backend:
    external: true
