#!/usr/bin/env bash
# Pre-commit hook: enforce Æ/æ branding automatically
set -euo pipefail

SCRIPT=".cursor/scripts/enforce-branding.py"

# Skip if branding script not found
[[ -f "$SCRIPT" ]] || exit 0

# Get staged files (excluding deleted)
staged_files=$(git diff --cached --name-only --diff-filter=d)
[[ -z "$staged_files" ]] && exit 0

# Check if any branding-relevant files are staged
has_relevant=false
while IFS= read -r file; do
    case "$file" in
        *.yaml|*.yml|*.env|*.md|*.mdc|*.py|*.sh) has_relevant=true; break ;;
    esac
done <<< "$staged_files"

[[ "$has_relevant" == false ]] && exit 0

# Run branding check on entire repo
if ! python3 "$SCRIPT" --check . >/dev/null 2>&1; then
    echo "[pre-commit] Branding issues detected — auto-fixing..."
    python3 "$SCRIPT" .

    # Re-stage originally staged files (they may have been fixed)
    while IFS= read -r file; do
        [[ -f "$file" ]] && git add "$file"
    done <<< "$staged_files"

    echo "[pre-commit] Fixed and re-staged."
fi
